name: C/C++ CI Windows 32-bit release build

env:
    QT_VERSION: '5.15.2'
    SQLITE_VERSION: '3400000'
    SQLITE_RELEASE_YEAR: '2022'
    QT_ARCH: 'win32_mingw81'
    PYTHON_VERSION: '3.9'
    QT_BIN_DIR: ../Qt/5.15.2/mingw81_32/bin
    PORTABLE_DIR: output/portable/SQLiteStudio
    INSTALLBUILDER_DIR: ../ib
    MINGW_URL: https://download.qt.io/online/qtsdkrepository/windows_x86/desktop/tools_mingw/qt.tools.win32_mingw810/8.1.0-1-202004170606i686-8.1.0-release-posix-dwarf-rt_v6-rev0.7z
    INSTALLBUILDER_URL: https://installbuilder.com/installbuilder-enterprise-22.6.0-windows-installer.exe

on:
  workflow_dispatch:
      branches: [ master ]
      

jobs:
  build:

    runs-on: Windows-2019

    steps:
            - name: Set up MinGW
              uses: egor-tensin/setup-mingw@v2
              with:
                platform: x86

            - name: Cache Qt
              id: cache-qt
              uses: actions/cache@v3
              with:
                path: ${{ github.workspace }}\..\Qt
                key: ${{ runner.os }}-${{ env.QT_VERSION }}-Qt-Cache
                
            - name: Install Qt
              uses: jurplel/install-qt-action@v3
              with:
                cache: true
                version: ${{ env.QT_VERSION }}
                host: 'windows'
                arch: ${{ env.QT_ARCH }}
                # jurplel/install-qt-action has a bug due to which we cannot use ${{ github.workspace }} for the "dir" property, because it will fail.
                dir: 'D:/'
                setup-python: 'false'
                
#    - name: Install Qt
 #     uses: jurplel/install-qt-action@v3
#      with:
#        host: 'windows'
#        target: 'desktop'
#        version: '5.9.2'
#        aqtversion: '==2.1.*'
#        archives: 'qtbase qtsvg'
#        cache: 'false'
#        cache-key-prefix: 'install-qt-action'
#        setup-python: 'true'
#        #arch: 'win64_msvc2019_64'
#        arch: 'win64_mingw81'
#        #arch: 'win32_mingw81'
#        modules: 'Desktop MinGW 8.1.0 32-bit Debug Information Files Qt Charts for MinGW 8.1.0 32-bit Qt Data Visualization for MinGW 8.1.0 32-bit Qt Lottie Animation for MinGW 8.1.0 32-bit Qt Network Authorization for MinGW 8.1.0 32-bit Qt Purchasing for MinGW 8.1.0 32-bit Qt Quick 3D for MinGW 8.1.0 32-bit Qt Quick Timeline for MinGW 8.1.0 32-bit Qt Script for MinGW 8.1.0 32-bit Qt Virtual Keyboard for MinGW 8.1.0 32-bit Qt WebGL Streaming Plugin for MinGW 8.1.0 32-bit'
#        tools: 'tools_cmake tools_generic'
#        #modules: 'qtcharts qtscript qtwebengine'
#        #modules: 'Desktop MinGW 8.1.0 32-bit Debug Information Files Qt Charts for MinGW 8.1.0 32-bit Qt Data Visualization for MinGW 8.1.0 32-bit Qt Lottie Animation for MinGW 8.1.0 32-bit Qt Network Authorization for MinGW 8.1.0 32-bit Qt Purchasing for MinGW 8.1.0 32-bit Qt Quick 3D for MinGW 8.1.0 32-bit Qt Quick Timeline for MinGW 8.1.0 32-bit Qt Script for MinGW 8.1.0 32-bit Qt Virtual Keyboard for MinGW 8.1.0 32-bit Qt WebGL Streaming Plugin for MinGW 8.1.0 32-bit'
#        #arch: 'win32_msvc2019'
#        ##modules: 'Desktop MSVC 2019 Debug Information Files Qt Charts for MSVC 2019 32-bit Qt Data Visualization for MSVC 2019 32-bit Qt Lottie Animation for MSVC 2019 32-bit Qt Network Authorization for MSVC 2019 32-bit Qt Purchasing for MSVC 2019 32-bit Qt Quick 3D for MSVC 2019 32-bit Qt Quick Timeline for MSVC 2019 32-bit Qt Script for MSVC 2019 32-bit Qt Virtual Keyboard for MSVC 2019 32-bit Qt WebEngine for msvc2019 32-bit Qt WebGL Streaming Plugin for MSVC 2019 32-bit'
#        #tools: 'tools_cmake tools_generic'
#        py7zrversion: '==0.19.*'
#        extra: '--external 7z'

        
    - uses: actions/checkout@v3
    - name: qmake
      run: qmake -makefile CaptureStream.pro
    - name: make
      run: make
      
    - name: Make CaptureStream executable
      run: chmod -R 755 ./CaptureStream
  
    - uses: actions/upload-artifact@v3
      with:
        name: CaptureStream
        path: ./CaptureStream
